

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ch_util._db_tables &mdash; ch_util 20.10.0+44.g2b46683 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/katex-math.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js"></script>
        <script src="../../_static/katex_autorenderer.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> ch_util
          

          
          </a>

          
            
            
              <div class="version">
                20.10.0+44.g2b46683
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ch_util</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>ch_util._db_tables</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ch_util._db_tables</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Private module for defining the DB tables with the peewee ORM.</span>

<span class="sd">These are imported into the layout and finder modules.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">import</span> <span class="nn">chimedb.core</span>
<span class="kn">import</span> <span class="nn">chimedb.data_index</span>
<span class="kn">from</span> <span class="nn">chimedb.core</span> <span class="kn">import</span> <span class="n">AlreadyExistsError</span> <span class="k">as</span> <span class="n">AlreadyExists</span>

<span class="kn">import</span> <span class="nn">peewee</span> <span class="k">as</span> <span class="nn">pw</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Logging</span>
<span class="c1"># =======</span>

<span class="c1"># Set default logging handler to avoid &quot;No handlers could be found for logger</span>
<span class="c1"># &#39;layout&#39;&quot; warnings.</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># All peewee-generated logs are logged to this namespace.</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;_db_tables&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>


<span class="c1"># Global variables and constants.</span>
<span class="c1"># ================================</span>

<span class="n">_property</span> <span class="o">=</span> <span class="nb">property</span>  <span class="c1"># Do this because we want a class named &quot;property&quot;.</span>
<span class="n">_user</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1">#: Return events at the specified time.</span>
<span class="n">EVENT_AT</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#: Return events before the specified time.</span>
<span class="n">EVENT_BEFORE</span> <span class="o">=</span> <span class="mi">1</span>
<span class="c1">#: Return events after the specified time.</span>
<span class="n">EVENT_AFTER</span> <span class="o">=</span> <span class="mi">2</span>
<span class="c1">#: Return all events (and ignore any specified time).</span>
<span class="n">EVENT_ALL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1">#: Order search results in ascending order.</span>
<span class="n">ORDER_ASC</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#: Order search results in descending order.</span>
<span class="n">ORDER_DESC</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Exceptions</span>
<span class="c1"># ==========</span>


<div class="viewcode-block" id="NoSubgraph"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.NoSubgraph">[docs]</a><span class="k">class</span> <span class="nc">NoSubgraph</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise when a subgraph specification is missing.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="BadSubgraph"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.BadSubgraph">[docs]</a><span class="k">class</span> <span class="nc">BadSubgraph</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise when an error in subgraph specification is made.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DoesNotExist"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.DoesNotExist">[docs]</a><span class="k">class</span> <span class="nc">DoesNotExist</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The event does not exist at the specified time.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="UnknownUser"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.UnknownUser">[docs]</a><span class="k">class</span> <span class="nc">UnknownUser</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The user requested is unknown.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="NoPermission"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.NoPermission">[docs]</a><span class="k">class</span> <span class="nc">NoPermission</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;User does not have permission for a task.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="LayoutIntegrity"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.LayoutIntegrity">[docs]</a><span class="k">class</span> <span class="nc">LayoutIntegrity</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Action would harm the layout integrity.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="PropertyType"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.PropertyType">[docs]</a><span class="k">class</span> <span class="nc">PropertyType</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bad property type.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="PropertyUnchanged"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.PropertyUnchanged">[docs]</a><span class="k">class</span> <span class="nc">PropertyUnchanged</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property change was requested, but no change is needed.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="ClosestDraw"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.ClosestDraw">[docs]</a><span class="k">class</span> <span class="nc">ClosestDraw</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CHIMEdbError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;There is a draw for the shortest path to a given component type.&quot;&quot;&quot;</span></div>


<span class="c1"># Helper classes for the peewee ORM</span>
<span class="c1"># =================================</span>

<span class="kn">from</span> <span class="nn">chimedb.core.orm</span> <span class="kn">import</span> <span class="n">JSONDictField</span><span class="p">,</span> <span class="n">EnumField</span><span class="p">,</span> <span class="n">base_model</span><span class="p">,</span> <span class="n">name_table</span>


<div class="viewcode-block" id="event_table"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_table">[docs]</a><span class="k">class</span> <span class="nc">event_table</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Baseclass for all models which are linked to the event class.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="event_table.event"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_table.event">[docs]</a>    <span class="k">def</span> <span class="nf">event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">when</span><span class="o">=</span><span class="n">EVENT_ALL</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;event(self, time = datetime.datetime.now(), type = None,\</span>
<span class="sd">                 when = EVENT_ALL, order = None, active = True)</span>
<span class="sd">           Find events associated with entries in this table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">          Event time.</span>
<span class="sd">        type : :obj:`event_type`</span>
<span class="sd">          Only get events of the specified type.</span>
<span class="sd">        when : int</span>
<span class="sd">          Event when.</span>
<span class="sd">        order : int or :obj:`None`</span>
<span class="sd">          Event order.</span>
<span class="sd">        active : bool</span>
<span class="sd">          Event active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        event : :obj:`peewee.SelectQuery`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">_graph_obj_iter</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dummy</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">type</span><span class="p">)</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="nb">type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="nb">type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>


<span class="c1"># Initializing connection to database.</span>
<span class="c1"># ====================================</span>


<div class="viewcode-block" id="connect_peewee_tables"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connect_peewee_tables">[docs]</a><span class="k">def</span> <span class="nf">connect_peewee_tables</span><span class="p">(</span><span class="n">read_write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reconnect</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize the connection to the CHIME data index database.</span>

<span class="sd">    This function uses the current database connector from</span>
<span class="sd">    :mod:`~chimedb.core` to establish a connection to the CHIME data</span>
<span class="sd">    index. It must be called if you change the connection method after</span>
<span class="sd">    importing this module. Or if you wish to connect with both read and write</span>
<span class="sd">    privileges.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    read_write : bool</span>
<span class="sd">        Whether to connect with read and write privileges.</span>
<span class="sd">    reconnect : bool</span>
<span class="sd">        Force a reconnection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">read_write</span><span class="p">,</span> <span class="n">reconnect</span><span class="p">)</span>

    <span class="c1"># Set the default, no-permissions user.</span>
    <span class="n">set_user</span><span class="p">(</span><span class="s2">&quot;Chime&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_user"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.set_user">[docs]</a><span class="k">def</span> <span class="nf">set_user</span><span class="p">(</span><span class="n">u</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify yourself as a user, for record keeping.</span>

<span class="sd">    All events recorded in the database are associated with a user, and not all</span>
<span class="sd">    users have all permissions. You must call this function before making any</span>
<span class="sd">    changes to the database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    u : string or integer</span>
<span class="sd">      Your user identifier: the integer id, the username, or the full name.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    UnknownUser</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_user</span>

    <span class="n">_user</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="c1"># Find the user.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
            <span class="s2">&quot;SELECT user_id FROM chimewiki.user WHERE user_id = </span><span class="si">%d</span><span class="s2">;&quot;</span> <span class="o">%</span> <span class="n">u</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">chimedb</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">proxy</span><span class="o">.</span><span class="n">execute_sql</span><span class="p">(</span>
            <span class="s2">&quot;SELECT user_id FROM chimewiki.user &quot;</span>
            <span class="s2">&quot;WHERE user_name = &#39;</span><span class="si">%s</span><span class="s2">&#39; OR &quot;</span>
            <span class="s2">&quot;user_real_name = &#39;</span><span class="si">%s</span><span class="s2">&#39;;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnknownUser</span><span class="p">(</span><span class="s2">&quot;Could not find user.&quot;</span><span class="p">)</span>
    <span class="n">_user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">_user</span><span class="p">[</span><span class="s2">&quot;perm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get permissions.</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">user_permission_type</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_permission</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_permission</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">_user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
    <span class="p">):</span>
        <span class="n">_user</span><span class="p">[</span><span class="s2">&quot;perm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_check_user</span><span class="p">(</span><span class="n">perm</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UnknownUser</span><span class="p">(</span>
            <span class="s2">&quot;You must call layout.set_user() before attempting to alter the DB.&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">perm</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_user</span><span class="p">[</span><span class="s2">&quot;perm&quot;</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">user_permission_type</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
                <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">user_permission_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">perm</span><span class="p">)</span>
                <span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoPermission</span><span class="p">(</span><span class="s2">&quot;You do not have the permissions to </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">long_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Wow, code is broken.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_peewee_get_current_user</span><span class="p">():</span>
    <span class="c1"># Get the current user for peewee, working around the issues with creating</span>
    <span class="c1"># instances before the local user has been set. The particular issue here is</span>
    <span class="c1"># that peewee creates an instance with the default values before setting the</span>
    <span class="c1"># ones fetched from the database, so although it seems like you shouldn&#39;t</span>
    <span class="c1"># need the user to have been set, you do.</span>

    <span class="k">if</span> <span class="n">_user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">_user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>


<span class="c1"># Tables in the DB pertaining to layouts</span>
<span class="c1"># ======================================</span>


<div class="viewcode-block" id="graph_obj"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.graph_obj">[docs]</a><span class="k">class</span> <span class="nc">graph_obj</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parent table for any table that has events associated with it.</span>
<span class="sd">    This is a way to make the event table polymorphic. It points to this table,</span>
<span class="sd">    which shares (unique) primary keys with child tables (e.g., component). It</span>
<span class="sd">    only has one key: ID.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">AutoField</span><span class="p">()</span></div>


<div class="viewcode-block" id="global_flag_category"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.global_flag_category">[docs]</a><span class="k">class</span> <span class="nc">global_flag_category</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Categories for global flags.</span>
<span class="sd">    Examples of component types are antennas, 60m coaxial cables, and so on.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the category.</span>
<span class="sd">    notes : string</span>
<span class="sd">        An (optional) description of the category.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="global_flag"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.global_flag">[docs]</a><span class="k">class</span> <span class="nc">global_flag</span><span class="p">(</span><span class="n">event_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A simple flag index for global flags.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : foreign key, primary key</span>
<span class="sd">        The ID shared with parent table graph_obj.</span>
<span class="sd">    category : foreign key</span>
<span class="sd">        The category of flag.</span>
<span class="sd">    severity  : enum(&#39;comment&#39;, &#39;warning&#39;, &#39;severe&#39;)</span>
<span class="sd">        An indication of how the data finder should react to this flag.</span>
<span class="sd">    inst : foreign key</span>
<span class="sd">        The acquisition instrument, if any, affected by this flag.</span>
<span class="sd">    name : string</span>
<span class="sd">        A short description of the flag.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Notes about the global flag.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">graph_obj</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;global_flag&quot;</span>
    <span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">global_flag_category</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;flag&quot;</span><span class="p">)</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">EnumField</span><span class="p">([</span><span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;warning&quot;</span><span class="p">,</span> <span class="s2">&quot;severe&quot;</span><span class="p">])</span>
    <span class="n">inst</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">chimedb</span><span class="o">.</span><span class="n">data_index</span><span class="o">.</span><span class="n">ArchiveInst</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;flag&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="global_flag.start"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.global_flag.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start this global flag.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        The following starts and ends a new global flag.</span>

<span class="sd">        &gt;&gt;&gt; cat = layout.global_flag_category.get(name = &quot;pass&quot;)</span>
<span class="sd">        &gt;&gt;&gt; flag = layout.global_flag(category = cat, severity = &quot;comment&quot;, name = &quot;run_pass12_a&quot;).start(time = datetime.datetime(2015, 4, 1, 12))</span>
<span class="sd">        &gt;&gt;&gt; flag.end(time = datetime.datetime(2015, 4, 5, 15, 30))</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the flag is to start.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : :obj:`global_flag`</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        :exc:`AlreadyExists` if the flag has already been started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;global_flag&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure that it has not been started before---i.e., that there is not an</span>
        <span class="c1"># active event associated with it.</span>
        <span class="n">g</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">global_flag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">g</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">global_flag</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">AlreadyExists</span><span class="p">(</span><span class="s2">&quot;This flag has already been started.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">o</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">graph_obj</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">global_flag</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Created global flag as event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">g</span></div>

<div class="viewcode-block" id="global_flag.end"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.global_flag.end">[docs]</a>    <span class="k">def</span> <span class="nf">end</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;End this global flag.</span>

<span class="sd">        See :meth:`global_flag.start` for an example.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the flag is to end.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : :obj:`global_flag`</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        :exc:`AlreadyExists` if the flag has already been ended; :exc:`DoesNotExist`</span>
<span class="sd">        if it has not been started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;global_flag&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure that it has been started but not ended.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">global_flag</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;This flag was never started.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">global_flag</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;This flag was never started.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">e</span><span class="o">.</span><span class="n">end</span>
            <span class="k">raise</span> <span class="n">AlreadyExists</span><span class="p">(</span><span class="s2">&quot;This event has already been ended.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="n">e</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Ended global flag.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="component_type"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component_type">[docs]</a><span class="k">class</span> <span class="nc">component_type</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CHIME component type.</span>
<span class="sd">    Examples of component types are antennas, 60m coaxial cables, and so on.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the component type.</span>
<span class="sd">    notes : string</span>
<span class="sd">        An (optional) description of the component type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="component_type_rev"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component_type_rev">[docs]</a><span class="k">class</span> <span class="nc">component_type_rev</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CHIME component type revision.</span>

<span class="sd">    Component types can, optionally, have revisions. For example, when an antenna</span>
<span class="sd">    design changes, a new revision is introduced.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    type : foreign key</span>
<span class="sd">        The component type this revision applies to.</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the component type.</span>
<span class="sd">    notes : string</span>
<span class="sd">        An (optional) description of the component type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">component_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;rev&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="external_repo"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.external_repo">[docs]</a><span class="k">class</span> <span class="nc">external_repo</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Information on an external repository.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the repository.</span>
<span class="sd">    root : string</span>
<span class="sd">        Its location, e.g., a URL onto which individual paths to files can be</span>
<span class="sd">        appended.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes about this repository.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="component"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component">[docs]</a><span class="k">class</span> <span class="nc">component</span><span class="p">(</span><span class="n">event_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A CHIME component.</span>

<span class="sd">    To add or remove components, use the :meth:`add` and :meth:`remove` methods.</span>
<span class="sd">    There are also methods for getting and setting component properties, history</span>
<span class="sd">    and documents.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : foreign key, primary key</span>
<span class="sd">        The ID shared with parent table graph_obj.</span>
<span class="sd">    sn : string, unique</span>
<span class="sd">        The unique serial number of the component.</span>
<span class="sd">    type : foreign key</span>
<span class="sd">        The component type.</span>
<span class="sd">    type_rev : foreign key</span>
<span class="sd">        The revision of this component.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">graph_obj</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;component&quot;</span>
    <span class="p">)</span>
    <span class="n">sn</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">component_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;component&quot;</span><span class="p">)</span>
    <span class="n">type_rev</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">component_type_rev</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;component&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;sn&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Reimplement the hash function. Peewee&#39;s default implementation, while</span>
        <span class="c1"># pretty sensible significantly slows down networkx when constructing a</span>
        <span class="c1"># graph as it is called a huge number of times</span>
        <span class="k">return</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="component.get_connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.get_connexion">[docs]</a>    <span class="k">def</span> <span class="nf">get_connexion</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">comp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
        <span class="n">when</span><span class="o">=</span><span class="n">EVENT_AT</span><span class="p">,</span>
        <span class="n">order</span><span class="o">=</span><span class="n">ORDER_ASC</span><span class="p">,</span>
        <span class="n">active</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get connexions involving this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comp : :obj:`component`</span>
<span class="sd">            If this parameter is set, then search for connexions between this</span>
<span class="sd">            component and *comp*.</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            Event time.</span>
<span class="sd">        when : int</span>
<span class="sd">            Event when.</span>
<span class="sd">        order : int</span>
<span class="sd">            Event order.</span>
<span class="sd">        active : bool</span>
<span class="sd">            Event active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A :obj:`peewee.SelectQuery` for :class:`connexion` entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">_graph_obj_iter</span><span class="p">(</span><span class="n">connexion</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">active</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">connexion</span><span class="o">.</span><span class="n">comp1</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">connexion</span><span class="o">.</span><span class="n">comp2</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">comp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">connexion</span><span class="o">.</span><span class="n">comp1</span> <span class="o">==</span> <span class="n">comp</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">connexion</span><span class="o">.</span><span class="n">comp2</span> <span class="o">==</span> <span class="n">comp</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">c</span></div>

<div class="viewcode-block" id="component.get_history"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.get_history">[docs]</a>    <span class="k">def</span> <span class="nf">get_history</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">when</span><span class="o">=</span><span class="n">EVENT_AT</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ORDER_ASC</span><span class="p">,</span> <span class="n">active</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get history items associated with this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            Event time.</span>
<span class="sd">        when : int</span>
<span class="sd">            Event when.</span>
<span class="sd">        order : int</span>
<span class="sd">            Event order.</span>
<span class="sd">        active : bool</span>
<span class="sd">            Event active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A :obj:`peewee.SelectQuery` for :class:`history` entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_graph_obj_iter</span><span class="p">(</span>
            <span class="n">component_history</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">EVENT_AT</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">component_history</span><span class="o">.</span><span class="n">comp</span> <span class="o">==</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="component.get_doc"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.get_doc">[docs]</a>    <span class="k">def</span> <span class="nf">get_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Get document pointers associated with this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the document events should be active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A :obj:`peewee.SelectQuery` for :class:`component_doc` entries.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_graph_obj_iter</span><span class="p">(</span><span class="n">component_doc</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">EVENT_AT</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">component_doc</span><span class="o">.</span><span class="n">comp</span> <span class="o">==</span> <span class="bp">self</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="component.add"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add this component.</span>

<span class="sd">        This triggers the &quot;component available&quot; event.</span>

<span class="sd">        To add many components at once, see :func:`add_component`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        The following makes a new LNA available:</span>

<span class="sd">        &gt;&gt;&gt; lna_type = layout.component_type.get(name = &quot;LNA&quot;)</span>
<span class="sd">        &gt;&gt;&gt; lna_rev = lna_type.rev.where(layout.component_type_rev.name == &quot;B&quot;).get()</span>
<span class="sd">        &gt;&gt;&gt; comp = layout.component(sn = &quot;LNA0000A&quot;, type = lna_type, rev = lna_type.rev).add()</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the component is to be made available.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>
<span class="sd">        force : bool</span>
<span class="sd">            If :obj:`False`, then raise :exc:`AlreadyExists` if this event creates a</span>
<span class="sd">            conflict; otherwise, do not add but ignore on conflict.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self : :obj:`component`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">add_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="component.remove"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.remove">[docs]</a>    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove this component.</span>

<span class="sd">        This ends the &quot;component available&quot; event.</span>

<span class="sd">        To remove many components at once, see :func:`remove_component`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the component is to be removed.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>
<span class="sd">        force : bool</span>
<span class="sd">            If :obj:`False`, then raise :exc:`DoesNotExist` if this event creates a</span>
<span class="sd">            conflict; otherwise, do not add but ignore on conflict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remove_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span></div>

<div class="viewcode-block" id="component.add_history"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.add_history">[docs]</a>    <span class="k">def</span> <span class="nf">add_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">timestamp_notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a history item for this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        notes : string</span>
<span class="sd">            The history note.</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the history is to be added.</span>
<span class="sd">        timestamp_notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        history : :obj:`component_history`</span>
<span class="sd">            The newly-created component history object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;comp_info&quot;</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">component_history</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
        <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">timestamp_notes</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">graph_obj</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">comp_history</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added component history as event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span></div>

<div class="viewcode-block" id="component.add_doc"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.add_doc">[docs]</a>    <span class="k">def</span> <span class="nf">add_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a document pointer for this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        repo : :obj:`external_repo`</span>
<span class="sd">            The place where the document is.</span>
<span class="sd">        ref : string</span>
<span class="sd">            A path or similar pointer, relevative to the root of *repo*.</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which the document pointer is to be added.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        history : :obj:`component_doc`</span>
<span class="sd">            The newly-created document pointer object.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;comp_info&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">external_repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">repo</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;Repository does not exist in the DB. Create it first.&quot;</span><span class="p">)</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">component_doc</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">repo</span><span class="o">=</span><span class="n">repo</span><span class="p">,</span> <span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">graph_obj</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">comp_doc</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added component document as event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="component.get_property"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.get_property">[docs]</a>    <span class="k">def</span> <span class="nf">get_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;Get a property for this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : :obj:`property_type`</span>
<span class="sd">            The property type to search for.</span>
<span class="sd">        time : obj:`datetime.datetime`</span>
<span class="sd">            The time at which to get the property.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        property : string</span>
<span class="sd">            If no property is set, then :obj:`None` is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">_graph_obj_iter</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">EVENT_AT</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="nb">property</span><span class="o">.</span><span class="n">comp_sn</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sn</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="nb">type</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="component.set_property"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component.set_property">[docs]</a>    <span class="k">def</span> <span class="nf">set_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a property for this component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : :obj:`property_type`</span>
<span class="sd">            The property type to search for.</span>
<span class="sd">        value : string</span>
<span class="sd">            The value to set.</span>
<span class="sd">        time : obj:`datetime.datetime`</span>
<span class="sd">            The time at which to get the property.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Notes for the timestamp.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        :exc:ValueError:, if *value* does not conform to the property regular</span>
<span class="sd">        expression.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Format a representation of the object</span>
        <span class="c1"># At the moment, cannot include the type info as it generates another query</span>
        <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;&lt;component serial=&#39;</span><span class="si">%s</span><span class="s2">&#39;&gt;&quot;</span>
        <span class="k">return</span> <span class="n">fmt</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">sn</span></div>


<div class="viewcode-block" id="component_history"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component_history">[docs]</a><span class="k">class</span> <span class="nc">component_history</span><span class="p">(</span><span class="n">event_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For providing history information on a component.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : foreign key, primary key</span>
<span class="sd">        The ID shared with parent table graph_obj.</span>
<span class="sd">    comp : foreign key</span>
<span class="sd">        The component linked to the history.</span>
<span class="sd">    notes : string</span>
<span class="sd">        The history information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">graph_obj</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;history&quot;</span>
    <span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">component</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;comp_sn&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;history&quot;</span>
    <span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">)</span></div>


<div class="viewcode-block" id="component_doc"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.component_doc">[docs]</a><span class="k">class</span> <span class="nc">component_doc</span><span class="p">(</span><span class="n">event_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For linking a component to a document in an external repository.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : foreign key, primary key</span>
<span class="sd">        The ID shared with parent table graph_obj.</span>
<span class="sd">    comp : foreign key</span>
<span class="sd">        The component linked to the document.</span>
<span class="sd">    repo : foreign key</span>
<span class="sd">        The repository holding the document.</span>
<span class="sd">    ref : string</span>
<span class="sd">        The location of the document within the repository (e.g., a filename).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">graph_obj</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;doc&quot;</span>
    <span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">component</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;comp_sn&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;doc&quot;</span>
    <span class="p">)</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">external_repo</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;doc&quot;</span><span class="p">)</span>
    <span class="n">ref</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">)</span></div>


<div class="viewcode-block" id="connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion">[docs]</a><span class="k">class</span> <span class="nc">connexion</span><span class="p">(</span><span class="n">event_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A connexion between two components.</span>

<span class="sd">    This should always be instatiated using the from_pair() method.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : foreign key, primary key</span>
<span class="sd">        The ID shared with parent table graph_obj.</span>
<span class="sd">    comp1 : foreign key</span>
<span class="sd">        The first component in the connexion.</span>
<span class="sd">    comp2 : foreign key</span>
<span class="sd">        The second component in the connexion.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">graph_obj</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;connexion&quot;</span>
    <span class="p">)</span>
    <span class="n">comp1</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">component</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;comp_sn1&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;conn1&quot;</span>
    <span class="p">)</span>
    <span class="n">comp2</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">component</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;comp_sn2&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;conn2&quot;</span>
    <span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;component_sn1&quot;</span><span class="p">,</span> <span class="s2">&quot;component_sn2&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="connexion.from_pair"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion.from_pair">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pair</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">,</span> <span class="n">allow_new</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a :obj:`connexion` given a pair of components.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comp1 : str or :obj:`component`</span>
<span class="sd">            Pass either the serial number or a :obj:`component` object.</span>
<span class="sd">        comp2 : str or :obj:`component`</span>
<span class="sd">            Pass either the serial number or a :obj:`component` object.</span>
<span class="sd">        allow_new : bool</span>
<span class="sd">            If :obj:`False`, then raise :exc:`peewee.DoesNotExist` if the connexion</span>
<span class="sd">            does not exist at all in the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        connexion : :obj:`connexion`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pair</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">(</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
                <span class="n">comp</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">sn</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pair</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="n">comp</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;Component </span><span class="si">%s</span><span class="s2"> does not exist.&quot;</span> <span class="o">%</span> <span class="n">comp</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">((</span><span class="bp">cls</span><span class="o">.</span><span class="n">comp1</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">comp2</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="o">|</span> <span class="p">((</span><span class="bp">cls</span><span class="o">.</span><span class="n">comp1</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">comp2</span> <span class="o">==</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">allow_new</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">comp1</span><span class="o">=</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">comp2</span><span class="o">=</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span></div>

<div class="viewcode-block" id="connexion.is_connected"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion.is_connected">[docs]</a>    <span class="k">def</span> <span class="nf">is_connected</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;See if a connexion exists.</span>

<span class="sd">        Connexions whose events have been deactivated are not included.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime</span>
<span class="sd">            The time at which to check whether the connexion exists.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        connected : bool</span>
<span class="sd">            :obj:`True` if there is a connexion, otherwise :obj:`False`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        peewee.DoesNotExist</span>
<span class="sd">            Raised if one or both of the components does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="p">(</span><span class="n">event_type</span><span class="o">.</span><span class="n">connexion</span><span class="p">(),</span> <span class="n">event_type</span><span class="o">.</span><span class="n">perm_connexion</span><span class="p">()),</span>
                <span class="n">when</span><span class="o">=</span><span class="n">EVENT_AT</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="connexion.is_permanent"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion.is_permanent">[docs]</a>    <span class="k">def</span> <span class="nf">is_permanent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;See if a permenant connexion exists.</span>

<span class="sd">        Connexions whose events have been deactivated are not included.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime</span>
<span class="sd">            The time at which to check whether the connexion exists.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        connected : bool</span>
<span class="sd">            :obj:`True` if there is a permanent connexion, otherwise :obj:`False`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        peewee.DoesNotExist</span>
<span class="sd">            Raised if one or both of the components does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">perm_connexion</span><span class="p">(),</span> <span class="n">when</span><span class="o">=</span><span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="connexion.other_comp"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion.other_comp">[docs]</a>    <span class="k">def</span> <span class="nf">other_comp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Given one component in the connexion, return the other.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comp : :obj:`component`</span>
<span class="sd">            The component you know in the connexion.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :obj:`component`</span>
<span class="sd">            The other component in the connexion, i.e., the one that isn&#39;t *comp*.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        :exc:`DoesNotExist`</span>
<span class="sd">            If *comp* is not part of this connexion, an exception occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp1</span> <span class="o">==</span> <span class="n">comp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp2</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp2</span> <span class="o">==</span> <span class="n">comp</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span>
                <span class="s2">&quot;The component you passed is not part of this connexion.&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="connexion.make"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion.make">[docs]</a>    <span class="k">def</span> <span class="nf">make</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a connexion.</span>
<span class="sd">        This method begins a connexion event at the specified time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which to begin the connexion event.</span>
<span class="sd">        permanent : bool</span>
<span class="sd">            If :obj:`True`, then make this a permanent connexion.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>
<span class="sd">        force : bool</span>
<span class="sd">            If :obj:`False`, then :exc:`AlreadyExists` will be raised if the connexion</span>
<span class="sd">            already exists; otherwise, conflicts will be ignored and nothing will be</span>
<span class="sd">            done.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        connexion : :obj:`connexion`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">make_connexion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">permanent</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">connexion</span><span class="o">.</span><span class="n">from_pair</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">comp1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp2</span><span class="p">)</span></div>

<div class="viewcode-block" id="connexion.sever"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.connexion.sever">[docs]</a>    <span class="k">def</span> <span class="nf">sever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sever a connexion.</span>
<span class="sd">        This method ends a connexion event at the specified time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        time : datetime.datetime</span>
<span class="sd">            The time at which to end the connexion event.</span>
<span class="sd">        notes : string</span>
<span class="sd">            Any notes for the timestamp.</span>
<span class="sd">        force : bool</span>
<span class="sd">            If :obj:`False`, then :exc:`DoesNotExists` will be raised if the connexion</span>
<span class="sd">            does not exist; otherwise, conflicts will be ignored and nothing will be</span>
<span class="sd">            done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sever_connexion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="property_type"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.property_type">[docs]</a><span class="k">class</span> <span class="nc">property_type</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A component property type.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the property type (e.g., &quot;attenuation&quot;).</span>
<span class="sd">    units : string</span>
<span class="sd">        The (optional) units of the property (e.g., &quot;dB&quot;).</span>
<span class="sd">    regex : string</span>
<span class="sd">        An (optional) regular expression for controlling allowed property values.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any (optional) notes further explaining the property.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">units</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="property_component"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.property_component">[docs]</a><span class="k">class</span> <span class="nc">property_component</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A list associating property types with components.</span>
<span class="sd">    A property can be for one or more component types. For example,</span>
<span class="sd">    &quot;dist_from_n_end&quot; is only a property of cassettes, but &quot;termination&quot; may be a</span>
<span class="sd">    property of LNA&#39;s, FLA&#39;s and so on. This is simply a table for matching</span>
<span class="sd">    property types to component types.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    prop_type : foreign key</span>
<span class="sd">        The property type to be mapped.</span>
<span class="sd">    comp_type : foreign key</span>
<span class="sd">        The component type to be mapped.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">prop_type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">property_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;property_component&quot;</span><span class="p">)</span>
    <span class="n">comp_type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">component_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;property_component&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;prop_type&quot;</span><span class="p">,</span> <span class="s2">&quot;comp_type&quot;</span><span class="p">),</span> <span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="property"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.property">[docs]</a><span class="k">class</span> <span class="nc">property</span><span class="p">(</span><span class="n">event_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A property associated with a particular component.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    id : foreign key, primary key</span>
<span class="sd">        The ID shared with parent table graph_obj.</span>
<span class="sd">    comp : foreign key</span>
<span class="sd">        The component to which this property belongs.</span>
<span class="sd">    type : foreign key</span>
<span class="sd">        The property type.</span>
<span class="sd">    value : string</span>
<span class="sd">        The actual property.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">graph_obj</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;property&quot;</span>
    <span class="p">)</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">component</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;comp_sn&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;property&quot;</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="s2">&quot;sn&quot;</span>
    <span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">property_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;property&quot;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;comp_sn, type_id&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="event_type"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type">[docs]</a><span class="k">class</span> <span class="nc">event_type</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;For differentiating event types.</span>

<span class="sd">    The class methods :meth:`comp_avail`, :meth:`connexion` and so on return</span>
<span class="sd">    event type instances, and internally store the result. Thus, subsequent calls</span>
<span class="sd">    do not generate more database queries. This can reduce overhead.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the event type.</span>
<span class="sd">    human_name : string</span>
<span class="sd">        A proper, English name.</span>
<span class="sd">    assoc_table : string</span>
<span class="sd">        The (optional) table that this event is about; it should be a child of</span>
<span class="sd">        graph_obj.</span>
<span class="sd">    no_end : enum(&#39;Y&#39;, &#39;N&#39;)</span>
<span class="sd">        If &#39;Y&#39;, then this is an &quot;instantaneous&quot; event, i.e., there will never be</span>
<span class="sd">        recorded an end.</span>
<span class="sd">    require_notes : enum(&#39;Y&#39;, &#39;N&#39;)</span>
<span class="sd">        If &#39;Y&#39;, then the notes of the event _must_ be set.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes about this event type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">human_name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">assoc_table</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">no_end</span> <span class="o">=</span> <span class="n">EnumField</span><span class="p">([</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
    <span class="n">require_notes</span> <span class="o">=</span> <span class="n">EnumField</span><span class="p">([</span><span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="event_type.comp_avail"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type.comp_avail">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">comp_avail</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For getting the component available event type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;comp_avail&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="event_type.connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type.connexion">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">connexion</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For getting the connexion event type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;connexion&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="event_type.property"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type.property">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">property</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For getting the property event type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;property&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="event_type.perm_connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type.perm_connexion">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">perm_connexion</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For getting the permanent connexion event type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;perm_connexion&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="event_type.comp_history"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type.comp_history">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">comp_history</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For getting the component history event type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;comp_history&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="event_type.comp_doc"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event_type.comp_doc">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">comp_doc</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For getting the component document event type.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;comp_doc&quot;</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">global_flag</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="s2">&quot;global_flag&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="timestamp"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.timestamp">[docs]</a><span class="k">class</span> <span class="nc">timestamp</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A timestamp.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    time : datetime</span>
<span class="sd">        The timestamp.</span>
<span class="sd">    entry_time : datetime</span>
<span class="sd">        The creation time of the timestamp.</span>
<span class="sd">    user_id : foreign key</span>
<span class="sd">        In the actual DB, this is a foreign key to chimewiki.user(user_id), but</span>
<span class="sd">        peewee doesn&#39;t support foreign keys to different schemas.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any (optional) notes about the timestamp.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Removed problematic constructor and replaced functionality with</span>
    <span class="c1"># the fact that peewee supports callables as default arguments.</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">entry_time</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">_peewee_get_current_user</span><span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="event"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event">[docs]</a><span class="k">class</span> <span class="nc">event</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An event, or timestamp, for something graphy.</span>

<span class="sd">    *Never* manually create, delete or alter events! Doing so can damage the</span>
<span class="sd">    integrity of the database.</span>

<span class="sd">    To interact with events, use:</span>

<span class="sd">    * :meth:`component.add`, :func:`add_component`, :meth:`component.remove` and</span>
<span class="sd">      :func:`remove_component` for starting and ending component</span>
<span class="sd">    * :meth:`connexion.make` and :meth:`connexion.sever` for making and severing</span>
<span class="sd">      connexions</span>
<span class="sd">    * :meth:`component.set_property` for starting/ending component properties</span>
<span class="sd">    * :meth:`component.add_history` and :meth:`component.add_doc` for adding</span>
<span class="sd">      component history and documents.</span>
<span class="sd">    * :meth:`global_flag.start`, :meth:`global_flag.end` to set a global flag.</span>

<span class="sd">    You can safely deactivate an event using :meth:`deactivate`; this method only</span>
<span class="sd">    allows deactivation if it will not damage the database integrity.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    active : bool</span>
<span class="sd">        Is this event active? (Instead of deleting events, we deactivate them.)</span>
<span class="sd">    replaces : foreign key</span>
<span class="sd">        Instead of editing events, we replace them, so that we have a history of</span>
<span class="sd">        event edits. This key indicates which event (if any) this event replaces.</span>
<span class="sd">    graph_obj : foreign key</span>
<span class="sd">        Which graph object is this event about?</span>
<span class="sd">    type : foreign key</span>
<span class="sd">        What kind of event is it?</span>
<span class="sd">    start : foreign key</span>
<span class="sd">        The timestamp for the event start.</span>
<span class="sd">    end : foreign key</span>
<span class="sd">        The timestamp for the event end.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">active</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">replaces</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="s2">&quot;self&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;replacement&quot;</span><span class="p">)</span>
    <span class="n">graph_obj</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">graph_obj</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;event&quot;</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;event&quot;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;event_start&quot;</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;event_end&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">(((</span><span class="s2">&quot;type_id&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">),</span> <span class="p">((</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_event_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">():</span>
            <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;comp_avail&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">connexion</span><span class="p">()</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">perm_connexion</span><span class="p">():</span>
            <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;connexion&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_history</span><span class="p">()</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_doc</span><span class="p">():</span>
            <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;comp_info&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">property</span><span class="p">():</span>
            <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;property&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">global_flag</span><span class="p">():</span>
            <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;global_flag&quot;</span><span class="p">)</span>
        <span class="c1"># Layout notes need to be reworked.</span>
        <span class="c1"># elif t == event_type.layout_note():</span>
        <span class="c1">#  _check_user(&quot;layout_note&quot;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoPermission</span><span class="p">(</span><span class="s2">&quot;This layout type cannot be deactivated.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="event.deactivate"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.event.deactivate">[docs]</a>    <span class="k">def</span> <span class="nf">deactivate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Deactivate an event.</span>

<span class="sd">        Events are never deleted; rather, the :attr:`active` flag is switched off.</span>
<span class="sd">        This method first checks to see whether doing so would break database</span>
<span class="sd">        integrity, and only deactivates if it will not.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        :exc:LayoutIntegrity: if deactivating will compromise layout integrity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_permission</span><span class="p">()</span>
        <span class="n">fail</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Event </span><span class="si">%d</span><span class="s2"> is already deactivated.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># If this is about component availability, do not deactivate if it is</span>
        <span class="c1"># connected, or if it has any properties, history or documents.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">():</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph_obj</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># Check history.</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_graph_obj_iter</span><span class="p">(</span>
                <span class="n">event</span><span class="p">,</span> <span class="n">component_history</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EVENT_ALL</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">component_history</span><span class="o">.</span><span class="n">comp</span> <span class="o">==</span> <span class="n">comp</span><span class="p">):</span>
                <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">_check_fail</span><span class="p">(</span>
                <span class="n">fail</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">LayoutIntegrity</span><span class="p">,</span>
                <span class="s2">&quot;Cannot deactivate because &quot;</span>
                <span class="s2">&quot;the following history event</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> set for this &quot;</span>
                <span class="s2">&quot;component&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail</span><span class="p">),</span> <span class="n">_are</span><span class="p">(</span><span class="n">fail</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="c1"># Check documents.</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_graph_obj_iter</span><span class="p">(</span>
                <span class="n">event</span><span class="p">,</span> <span class="n">component_doc</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EVENT_ALL</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">component_doc</span><span class="o">.</span><span class="n">comp</span> <span class="o">==</span> <span class="n">comp</span><span class="p">):</span>
                <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">_check_fail</span><span class="p">(</span>
                <span class="n">fail</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">LayoutIntegrity</span><span class="p">,</span>
                <span class="s2">&quot;Cannot deactivate because &quot;</span>
                <span class="s2">&quot;the following document event</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> set for this &quot;</span>
                <span class="s2">&quot;component&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail</span><span class="p">),</span> <span class="n">_are</span><span class="p">(</span><span class="n">fail</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="c1"># Check properties.</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_graph_obj_iter</span><span class="p">(</span>
                <span class="n">event</span><span class="p">,</span> <span class="nb">property</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">EVENT_ALL</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span>
            <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">comp</span> <span class="o">==</span> <span class="n">comp</span><span class="p">):</span>
                <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">_check_fail</span><span class="p">(</span>
                <span class="n">fail</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">LayoutIntegrity</span><span class="p">,</span>
                <span class="s2">&quot;Cannot deactivate because &quot;</span>
                <span class="s2">&quot;the following property event</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> set for this &quot;</span>
                <span class="s2">&quot;component&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail</span><span class="p">),</span> <span class="n">_are</span><span class="p">(</span><span class="n">fail</span><span class="p">)),</span>
            <span class="p">)</span>

            <span class="c1"># Check connexions.</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_connexion</span><span class="p">(</span><span class="n">when</span><span class="o">=</span><span class="n">EVENT_ALL</span><span class="p">):</span>
                <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">conn</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
            <span class="n">_check_fail</span><span class="p">(</span>
                <span class="n">fail</span><span class="p">,</span>
                <span class="kc">False</span><span class="p">,</span>
                <span class="n">LayoutIntegrity</span><span class="p">,</span>
                <span class="s2">&quot;Cannot deactivate because &quot;</span>
                <span class="s2">&quot;the following component</span><span class="si">%s</span><span class="s2"> are connected&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail</span><span class="p">)),</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deactivated event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Replace one or both timestamps for an event.</span>

<span class="sd">        Currently, the following is not supported and will raise a</span>
<span class="sd">        :exc:`RuntimeError` exception:</span>

<span class="sd">        - replacing the end time of a component availability event;</span>
<span class="sd">        - replacing the start time of a component availability event if the start</span>
<span class="sd">          time is *later* than the current start time.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start : :obj:`timestamp`</span>
<span class="sd">            The new starting timestamp. If :obj:`None`, then the starting timestamp is</span>
<span class="sd">            not altered.</span>
<span class="sd">        end : :obj:`timestamp`</span>
<span class="sd">            The new end timestamp. If this is set to :obj:`None` *and* **force_end**</span>
<span class="sd">            is :obj:`True`, then the event will be set with no end time.</span>
<span class="sd">        force_end : bool</span>
<span class="sd">            If :obj:`True`, then a value of :obj:`None` for **end** is interpreted as</span>
<span class="sd">            having no end time; otherwise, :obj:`None` for **end** will not change the</span>
<span class="sd">            end timestamp.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        event : :obj:`event`</span>
<span class="sd">            The modified event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_permission</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">end</span> <span class="ow">or</span> <span class="n">force_end</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;This method does not currently support ending &quot;</span>
                    <span class="s2">&quot;component availability events.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;This method does not currently support moving a &quot;</span>
                    <span class="s2">&quot;component availability event later.&quot;</span>
                <span class="p">)</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">timestamp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">start</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">start</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">force_end</span><span class="p">:</span>
                <span class="n">end</span> <span class="o">=</span> <span class="n">_pw_getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">end</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">start</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LayoutIntegrity</span><span class="p">(</span><span class="s2">&quot;End time cannot be earlier than start time.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">timestamp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">end</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">end</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">new</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">replaces</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">graph_obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_obj</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
            <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span> <span class="o">=</span> <span class="n">new</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<div class="viewcode-block" id="predef_subgraph_spec"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.predef_subgraph_spec">[docs]</a><span class="k">class</span> <span class="nc">predef_subgraph_spec</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A specification for a subgraph of a full graph.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of this subgraph specification.</span>
<span class="sd">    start_type : foreign key</span>
<span class="sd">        The starting component type.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Optional notes about this specification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">start_type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span>
        <span class="n">component_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;predef_subgraph_spec_start&quot;</span>
    <span class="p">)</span>
    <span class="n">notes</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="predef_subgraph_spec_param"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.predef_subgraph_spec_param">[docs]</a><span class="k">class</span> <span class="nc">predef_subgraph_spec_param</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parameters for a subgraph specification.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    predef_subgraph_spec : foreign key</span>
<span class="sd">        The subgraph which this applies.</span>
<span class="sd">    type1 : foreign key</span>
<span class="sd">        A component type.</span>
<span class="sd">    type2 : foreign key</span>
<span class="sd">        A component type.</span>
<span class="sd">    action : enum(&#39;T&#39;, &#39;H&#39;, &#39;O&#39;)</span>
<span class="sd">        The role of this component type:</span>
<span class="sd">        - T: terminate at type1 (type2 is left NULL).</span>
<span class="sd">        - H: hide type1 (type2 is left NULL).</span>
<span class="sd">        - O: only draw connexions one way between type1 and type2.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">predef_subgraph_spec</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">predef_subgraph_spec</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;param&quot;</span><span class="p">)</span>
    <span class="n">type1</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">component_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;subgraph_param1&quot;</span><span class="p">)</span>
    <span class="n">type2</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">component_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;subgraph_param2&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">EnumField</span><span class="p">([</span><span class="s2">&quot;T&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">])</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;predef_subgraph_spec&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="user_permission_type"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.user_permission_type">[docs]</a><span class="k">class</span> <span class="nc">user_permission_type</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines permissions for the DB interface.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : string</span>
<span class="sd">        The name of the permission.</span>
<span class="sd">    notes : string</span>
<span class="sd">        An (optional) description of the permission.</span>
<span class="sd">        peewee doesn&#39;t support foreign keys to different schemas.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">long_name</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">65000</span><span class="p">)</span></div>


<div class="viewcode-block" id="user_permission"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.user_permission">[docs]</a><span class="k">class</span> <span class="nc">user_permission</span><span class="p">(</span><span class="n">base_model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Specifies users&#39; permissions.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    user_id : foreign key</span>
<span class="sd">        In the actual DB, this is a foreign key to chimewiki.user(user_id), but</span>
<span class="sd">        peewee doesn&#39;t support foreign keys to different schemas.</span>
<span class="sd">    type : foreign key</span>
<span class="sd">        The permission type to grant to the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">pw</span><span class="o">.</span><span class="n">ForeignKeyField</span><span class="p">(</span><span class="n">user_permission_type</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span></div>


<span class="c1"># Functions for manipulating layout tables in a robust way.</span>
<span class="c1"># =========================================================</span>


<span class="k">def</span> <span class="nf">_graph_obj_iter</span><span class="p">(</span><span class="n">sel</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">active</span><span class="p">):</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">sel</span><span class="o">.</span><span class="n">select</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sel</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;event&quot;</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">graph_obj</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">sel</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">obj</span><span class="o">.</span><span class="n">graph_obj</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">when</span> <span class="o">==</span> <span class="n">EVENT_AT</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
            <span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">end</span><span class="p">),</span> <span class="n">join_type</span><span class="o">=</span><span class="n">pw</span><span class="o">.</span><span class="n">JOIN</span><span class="o">.</span><span class="n">LEFT_OUTER</span><span class="p">)</span>
            <span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">start</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="n">time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">end</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;&gt;</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">time</span><span class="p">)))</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">when</span> <span class="o">==</span> <span class="n">EVENT_BEFORE</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">when</span> <span class="o">==</span> <span class="n">EVENT_AFTER</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">event</span><span class="o">.</span><span class="n">start</span><span class="p">))</span>
            <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">time</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">when</span> <span class="o">==</span> <span class="n">EVENT_AT</span><span class="p">)</span> <span class="ow">and</span> <span class="n">order</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="n">ORDER_ASC</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">order</span> <span class="o">==</span> <span class="n">ORDER_DESC</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">timestamp</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unknown value of &#39;when&#39; passed (</span><span class="si">%d</span><span class="s2">).&quot;</span> <span class="o">%</span> <span class="n">when</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">_pw_getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">default</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="k">def</span> <span class="nf">_check_property_type</span><span class="p">(</span><span class="n">ptype</span><span class="p">,</span> <span class="n">ctype</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">property_type</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">ptype</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">DoesNotExist</span><span class="p">(</span><span class="s2">&quot;Property type does not exist in the DB.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">property_type</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">property_type</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">ptype</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">property_component</span>
        <span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">property_component</span><span class="o">.</span><span class="n">comp_type</span> <span class="o">==</span> <span class="n">ctype</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>
    <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PropertyType</span><span class="p">(</span>
            <span class="s1">&#39;Property type &quot;</span><span class="si">%s</span><span class="s1">&quot; cannot be used for component &#39;</span>
            <span class="s1">&#39;type &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ptype</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ctype</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_fail</span><span class="p">(</span><span class="n">fail</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">exception</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fail</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_conj</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;s&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span> <span class="nf">_plural</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;s&quot;</span>


<span class="k">def</span> <span class="nf">_does</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;does&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;do&quot;</span>


<span class="k">def</span> <span class="nf">_are</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;is&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;are&quot;</span>


<div class="viewcode-block" id="compare_connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.compare_connexion">[docs]</a><span class="k">def</span> <span class="nf">compare_connexion</span><span class="p">(</span><span class="n">conn1</span><span class="p">,</span> <span class="n">conn2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;See if two connexions are the same.</span>
<span class="sd">    Because the :class:`connexion` could store the two components in different</span>
<span class="sd">    orders, or have different instances of the same component object, direct</span>
<span class="sd">    comparison may fail. This function explicitly compares both possible</span>
<span class="sd">    combinations of serial numbers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    conn1 : :obj:`connexion`</span>
<span class="sd">        The first connexion object.</span>
<span class="sd">    conn2 : :obj:`connexion`</span>
<span class="sd">        The second connexion object.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :obj:`True` if the connexions are the same, :obj:`False` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sn11</span> <span class="o">=</span> <span class="n">conn1</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span>
    <span class="n">sn12</span> <span class="o">=</span> <span class="n">conn1</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span>
    <span class="n">sn21</span> <span class="o">=</span> <span class="n">conn2</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span>
    <span class="n">sn22</span> <span class="o">=</span> <span class="n">conn2</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sn11</span> <span class="o">==</span> <span class="n">sn21</span> <span class="ow">and</span> <span class="n">sn12</span> <span class="o">==</span> <span class="n">sn22</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">sn11</span> <span class="o">==</span> <span class="n">sn22</span> <span class="ow">and</span> <span class="n">sn12</span> <span class="o">==</span> <span class="n">sn21</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="add_component"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.add_component">[docs]</a><span class="k">def</span> <span class="nf">add_component</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make one or more components available with a common timestamp.</span>

<span class="sd">    If you are adding only one component, this function is equivalent to calling</span>
<span class="sd">    :meth:`component.add`. However, multiple calls to :meth:`component.add`</span>
<span class="sd">    generate a unique timestamp per call. To assign a single timestamp to many</span>
<span class="sd">    additions at once, use this function.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; lna_type = layout.component_type.get(name = &quot;LNA&quot;)</span>
<span class="sd">    &gt;&gt;&gt; lna_rev = lna_type.rev.where(layout.component_type_rev.name == &quot;B&quot;).get()</span>
<span class="sd">    &gt;&gt;&gt; c = []</span>
<span class="sd">    &gt;&gt;&gt; for i in range(0, 10):</span>
<span class="sd">    ...   c.append(layout.component(sn = &quot;LNA%04dB&quot; % (i), type = lna_type, rev = lna_rev))</span>
<span class="sd">    &gt;&gt;&gt; layout.add_component(c, time = datetime(2014, 10, 10, 11), notes = &quot;Adding many at once.&quot;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    comp : list of :obj:`component` objects</span>
<span class="sd">        The components to make available.</span>
<span class="sd">    time : datetime.datetime</span>
<span class="sd">        The time at which to make the components available.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes for the timestamp.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If :obj:`True`, then add any components that can be added, while doing</span>
<span class="sd">        nothing (except making note of such in the logger) for components whose</span>
<span class="sd">        addition would violate database integrity. If :obj:`False`,</span>
<span class="sd">        :exc:`AlreadyExists` is raised for any addition that violates database</span>
<span class="sd">        integrity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">copy</span>

    <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;comp_avail&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="n">comp</span>

    <span class="c1"># First check to see that the component does not already exist at this time.</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_add</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_add_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="n">to_add_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">(),</span> <span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="n">to_add_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>

    <span class="c1"># Also add permanently connected components.</span>
    <span class="n">done</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">to_add</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">to_add</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
            <span class="n">this_add</span><span class="p">,</span> <span class="n">this_sn</span> <span class="o">=</span> <span class="n">_get_perm_connexion_recurse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
            <span class="n">add</span> <span class="o">+=</span> <span class="n">this_add</span>
            <span class="n">sn</span> <span class="o">+=</span> <span class="n">this_sn</span>
            <span class="n">to_add</span> <span class="o">+=</span> <span class="n">add</span>
            <span class="n">to_add_sn</span> <span class="o">+=</span> <span class="n">sn</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="c1"># If the component doesn&#39;t exist in the DB, then it can&#39;t have any</span>
            <span class="c1"># permanent connexions.</span>
            <span class="k">pass</span>

    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail</span><span class="p">,</span>
        <span class="n">force</span><span class="p">,</span>
        <span class="n">AlreadyExists</span><span class="p">,</span>
        <span class="s2">&quot;Aborting because the following &quot;</span>
        <span class="s2">&quot;component</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> already available at that time&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail</span><span class="p">),</span> <span class="n">_are</span><span class="p">(</span><span class="n">fail</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_add</span><span class="p">):</span>
        <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">to_add</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">comp</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">o</span>
            <span class="n">comp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If the component is already available after this time, replace it with</span>
            <span class="c1"># an event starting at this new time.</span>
            <span class="n">e_old</span> <span class="o">=</span> <span class="n">comp</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">(),</span> <span class="n">EVENT_AFTER</span><span class="p">,</span> <span class="n">ORDER_ASC</span>
            <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">e_old</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Added </span><span class="si">%s</span><span class="s2"> by replacing previous event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">e_old</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">graph_obj</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added </span><span class="si">%s</span><span class="s2"> with new event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_add</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Added </span><span class="si">%d</span><span class="s2"> new component</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_add</span><span class="p">),</span> <span class="n">_plural</span><span class="p">(</span><span class="n">to_add</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_add_sn</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added no new component.&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_perm_connexion_recurse</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">done</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">add</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">add_sn</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">comp</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">add_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
    <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_connexion</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_permanent</span><span class="p">():</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">other_comp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">_get_perm_connexion_recurse</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
                <span class="n">add</span> <span class="o">+=</span> <span class="n">a</span>
                <span class="n">add_sn</span> <span class="o">+=</span> <span class="n">s</span>

    <span class="k">return</span> <span class="n">add</span><span class="p">,</span> <span class="n">add_sn</span>


<span class="k">def</span> <span class="nf">_check_perm_connexion_recurse</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">done</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ev_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">comp</span><span class="o">.</span><span class="n">get_connexion</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_permanent</span><span class="p">():</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">other_comp</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">done</span><span class="p">:</span>
                <span class="n">e</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">_check_perm_connexion_recurse</span><span class="p">(</span><span class="n">c2</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span>
                <span class="n">fail</span> <span class="o">+=</span> <span class="n">f</span>
                <span class="n">ev</span> <span class="o">+=</span> <span class="n">e</span>
                <span class="n">ev_sn</span> <span class="o">+=</span> <span class="n">s</span>
                <span class="n">done</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">conn</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>

    <span class="n">ev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">(),</span> <span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="n">ev_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ev</span><span class="p">,</span> <span class="n">ev_sn</span><span class="p">,</span> <span class="n">fail</span>


<div class="viewcode-block" id="remove_component"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.remove_component">[docs]</a><span class="k">def</span> <span class="nf">remove_component</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;End availability of one or more components with a common timestamp.</span>

<span class="sd">    If you are adding only one component, this function is equivalent to calling</span>
<span class="sd">    :meth:`component.remove`. However, multiple calls to :meth:`component.remove`</span>
<span class="sd">    generate a unique timestamp per call. To assign a single timestamp to many</span>
<span class="sd">    additions at once, use this function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    comp : list of :obj:`component` objects</span>
<span class="sd">        The components to end availability of.</span>
<span class="sd">    time : datetime.datetime</span>
<span class="sd">        The time at which to end availability.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes for the timestamp.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If :obj:`True`, then remove any components that can be removed, while doing</span>
<span class="sd">        nothing (except making note of such in the logger) for components whose</span>
<span class="sd">        removal would violate database integrity. If :obj:`False`,</span>
<span class="sd">        :exc:`DoesNotExist` is raised for any addition that violates database</span>
<span class="sd">        integrity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;comp_avail&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="n">comp</span>

    <span class="c1"># First check to see that the component already exists at this time; also</span>
    <span class="c1"># ensure that it is not connected to anything.</span>
    <span class="n">fail_avail</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fail_conn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fail_perm_conn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ev_comp_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">component</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sn</span><span class="o">=</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">(),</span> <span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="n">found_conn</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">conn</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">get_connexion</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">conn</span><span class="o">.</span><span class="n">is_permanent</span><span class="p">():</span>
                    <span class="n">fail_conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;-&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">conn</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
                    <span class="n">found_conn</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">perm_ev</span><span class="p">,</span> <span class="n">perm_ev_sn</span><span class="p">,</span> <span class="n">perm_fail</span> <span class="o">=</span> <span class="n">_check_perm_connexion_recurse</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">perm_fail</span><span class="p">):</span>
                <span class="n">fail_perm_conn</span> <span class="o">+=</span> <span class="n">perm_fail</span>
                <span class="n">found_conn</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">perm_ev</span><span class="p">):</span>
                <span class="n">ev</span> <span class="o">+=</span> <span class="n">perm_ev</span>
                <span class="n">ev_comp_sn</span> <span class="o">+=</span> <span class="n">perm_ev_sn</span>
                <span class="n">found_conn</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_conn</span><span class="p">:</span>
                <span class="n">ev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">comp_avail</span><span class="p">(),</span> <span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">ev_comp_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">fail_avail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
            <span class="k">pass</span>

    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail_avail</span><span class="p">,</span>
        <span class="n">force</span><span class="p">,</span>
        <span class="n">LayoutIntegrity</span><span class="p">,</span>
        <span class="s2">&quot;The following component</span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> not available at that time, or you have specified an &quot;</span>
        <span class="s2">&quot;end time earlier than </span><span class="si">%s</span><span class="s2"> start time</span><span class="si">%s</span><span class="s2">&quot;</span>
        <span class="o">%</span> <span class="p">(</span>
            <span class="n">_plural</span><span class="p">(</span><span class="n">fail_avail</span><span class="p">),</span>
            <span class="n">_are</span><span class="p">(</span><span class="n">fail_avail</span><span class="p">),</span>
            <span class="s2">&quot;its&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail_avail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;their&quot;</span><span class="p">,</span>
            <span class="n">_plural</span><span class="p">(</span><span class="n">fail_avail</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail_conn</span><span class="p">,</span>
        <span class="n">force</span><span class="p">,</span>
        <span class="n">LayoutIntegrity</span><span class="p">,</span>
        <span class="s2">&quot;Cannot remove because the &quot;</span>
        <span class="s2">&quot;following component</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> connected&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail_conn</span><span class="p">),</span> <span class="n">_are</span><span class="p">(</span><span class="n">fail_conn</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail_perm_conn</span><span class="p">,</span>
        <span class="n">force</span><span class="p">,</span>
        <span class="n">LayoutIntegrity</span><span class="p">,</span>
        <span class="s2">&quot;Cannot remove because &quot;</span>
        <span class="s2">&quot;the following component</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> connected (via permanent &quot;</span>
        <span class="s2">&quot;connexions)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail_perm_conn</span><span class="p">),</span> <span class="n">_are</span><span class="p">(</span><span class="n">fail_perm_conn</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">t_stamp</span>
        <span class="n">e</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removed component by ending event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Removed </span><span class="si">%d</span><span class="s2"> component</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="n">_plural</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ev_comp_sn</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removed no component.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="set_property"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.set_property">[docs]</a><span class="k">def</span> <span class="nf">set_property</span><span class="p">(</span>
    <span class="n">comp</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set a property value for one or more components with a common timestamp.</span>

<span class="sd">    Passing :obj:`None` for the property value erases that property from the</span>
<span class="sd">    component.</span>

<span class="sd">    If you altering only one component, this function is equivalent to calling</span>
<span class="sd">    :meth:`component.set_property`. However, multiple calls to</span>
<span class="sd">    :meth:`component.set_property` generate a unique timestamp per call. To</span>
<span class="sd">    assign a single timestamp to many additions at once, use this function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    comp : list of :obj:`component` objects</span>
<span class="sd">        The components to assign the property to.</span>
<span class="sd">    type : :obj:`property_type`</span>
<span class="sd">        The property type.</span>
<span class="sd">    value : str</span>
<span class="sd">        The property value to assign.</span>
<span class="sd">    time : datetime.datetime</span>
<span class="sd">        The time at which to end availability.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes for the timestamp.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If :obj:`False`, then complain if altering the property does nothing (e.g.,</span>
<span class="sd">        because the property value would be unchanged for a certain component);</span>
<span class="sd">        otherwise, ignore such situations and merely issue logging information on</span>
<span class="sd">        them.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    :exc:ValueError:, if *value* does not conform to the property type&#39;s regular</span>
<span class="sd">    expression; :exc:PropertyUnchanged: if *force* is :obj:`False`: and a</span>
<span class="sd">    component&#39;s property value would remain unaltered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;property&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">component</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">comp</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comp_list</span> <span class="o">=</span> <span class="n">comp</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
        <span class="n">_check_property_type</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">comp</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">regex</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="n">regex</span><span class="p">),</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Value &quot;</span><span class="si">%s</span><span class="s1">&quot; does not conform to regular &#39;</span>
                <span class="s2">&quot;expression </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="o">.</span><span class="n">regex</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">fail</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_end</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_end_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_set</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_set_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">comp_list</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If this property type is already set, then end it---unless the value is</span>
            <span class="c1"># exactly the same, in which case don&#39;t do anything.</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">_graph_obj_iter</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">EVENT_AT</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="nb">property</span><span class="o">.</span><span class="n">comp</span> <span class="o">==</span> <span class="n">comp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">property</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="nb">type</span><span class="p">))</span>
                <span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">to_end_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
                <span class="n">to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
                <span class="n">to_set_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>
            <span class="n">to_set</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">)</span>
            <span class="n">to_set_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="o">.</span><span class="n">sn</span><span class="p">)</span>

    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail</span><span class="p">,</span>
        <span class="n">force</span><span class="p">,</span>
        <span class="n">PropertyUnchanged</span><span class="p">,</span>
        <span class="s2">&quot;The following component</span><span class="si">%s</span><span class="s2"> &quot;</span>
        <span class="s2">&quot;property does not change&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="s2">&quot;&#39;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;s&#39;&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># End any events that need to be ended.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_end</span><span class="p">):</span>
        <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">to_end</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">event_type</span><span class="o">.</span><span class="n">property</span><span class="p">(),</span> <span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">e</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">t_stamp</span>
            <span class="n">e</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># If no value was passed, then we are done.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Removed property </span><span class="si">%s</span><span class="s2"> from the following </span><span class="si">%d</span><span class="s2"> component</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_end</span><span class="p">),</span> <span class="n">_plural</span><span class="p">(</span><span class="n">to_end</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_end_sn</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Start the event with a common timestamp.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_set</span><span class="p">):</span>
        <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">to_set</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="n">p</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">graph_obj</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">property</span><span class="p">(),</span> <span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Added property </span><span class="si">%s</span><span class="s2">=</span><span class="si">%s</span><span class="s2"> to the following component</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_plural</span><span class="p">(</span><span class="n">to_set</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_set_sn</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No component property was changed.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="make_connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.make_connexion">[docs]</a><span class="k">def</span> <span class="nf">make_connexion</span><span class="p">(</span>
    <span class="n">conn</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">permanent</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Connect one or more component pairs with a common timestamp.</span>

<span class="sd">    If you are connecting only one pair, this function is equivalent to calling</span>
<span class="sd">    :meth:`connexion.make`. However, multiple calls to :meth:`connexion.make`</span>
<span class="sd">    generate a unique timestamp per call. To assign a single timestamp to many</span>
<span class="sd">    connexions at once, use this function.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; conn = []</span>
<span class="sd">    &gt;&gt;&gt; for i in range(0, 10):</span>
<span class="sd">    ...  comp1 = layout.component.get(sn = &quot;LNA%04dB&quot; % (i))</span>
<span class="sd">    ...  comp2 = layout.component.get(sn = &quot;CXA%04dB&quot;% (i))</span>
<span class="sd">    ...  conn.append(layout.connexion.from_pair(comp1, comp2))</span>
<span class="sd">    &gt;&gt;&gt; layout.make_connexion(conn, time = datetime(2013, 10, 11, 23, 15), notes = &quot;Making multiple connexions at once.&quot;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    comp : list of :obj:`connexion` objects</span>
<span class="sd">        The connexions to make.</span>
<span class="sd">    time : datetime.datetime</span>
<span class="sd">        The time at which to end availability.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes for the timestamp.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If :obj:`True`, then remove any components that can be removed, while doing</span>
<span class="sd">        nothing (except making note of such in the logger) for components whose</span>
<span class="sd">        removal would violate database integrity. If :obj:`False`,</span>
<span class="sd">        :exc:`DoesNotExist` is raised for any addition that violates database</span>
<span class="sd">        integrity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;connexion&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">connexion</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">]</span>

    <span class="c1"># Check that the connexions do not yet exist.</span>
    <span class="n">fail</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_conn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_conn_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_connected</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
            <span class="n">fail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;=&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">to_conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">to_conn_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;=&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fail</span><span class="p">):</span>
        <span class="n">_check_fail</span><span class="p">(</span>
            <span class="n">fail</span><span class="p">,</span>
            <span class="n">force</span><span class="p">,</span>
            <span class="n">AlreadyExists</span><span class="p">,</span>
            <span class="s2">&quot;Cannot connect because the following connexions already exist&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">to_conn</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If there is a connexion after this time, replace it with an event</span>
            <span class="c1"># starting at this new time.</span>
            <span class="n">e_old</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">EVENT_AFTER</span><span class="p">,</span> <span class="n">ORDER_ASC</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="n">e_old</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added connexion by replacing previous event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e_old</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">connexion</span><span class="o">.</span><span class="n">from_pair</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="p">,</span> <span class="n">allow_new</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">id</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">o</span> <span class="o">=</span> <span class="n">graph_obj</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
                <span class="n">conn</span> <span class="o">=</span> <span class="n">connexion</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="n">comp1</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="p">,</span> <span class="n">comp2</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">permanent</span><span class="p">:</span>
                <span class="n">e_type</span> <span class="o">=</span> <span class="n">event_type</span><span class="o">.</span><span class="n">perm_connexion</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e_type</span> <span class="o">=</span> <span class="n">event_type</span><span class="o">.</span><span class="n">connexion</span><span class="p">()</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">graph_obj</span><span class="o">=</span><span class="n">o</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">e_type</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">t_stamp</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Added connexion with new event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_conn</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Added </span><span class="si">%d</span><span class="s2"> new connexion</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">to_conn</span><span class="p">),</span> <span class="n">_plural</span><span class="p">(</span><span class="n">to_conn</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">to_conn_sn</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Added no new connexions.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="sever_connexion"><a class="viewcode-back" href="../../_autosummary/ch_util._db_tables.html#ch_util._db_tables.sever_connexion">[docs]</a><span class="k">def</span> <span class="nf">sever_connexion</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">notes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sever one or more component pairs with a common timestamp.</span>

<span class="sd">    If you are severing only one pair, this function is equivalent to calling</span>
<span class="sd">    :meth:`connexion.sever`. However, multiple calls to :meth:`connexion.sever`</span>
<span class="sd">    generate a unique timestamp per call. To assign a single timestamp to many</span>
<span class="sd">    connexion severances at once, use this function.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; conn = []</span>
<span class="sd">    &gt;&gt;&gt; for i in range(0, 10):</span>
<span class="sd">    ...  comp1 = layout.component.get(sn = &quot;LNA%04dB&quot; % (i))</span>
<span class="sd">    ...  comp2 = layout.component.get(sn = &quot;CXA%04dB&quot;% (i))</span>
<span class="sd">    ...  conn.append(layout.connexion.from_pair(comp1, comp2))</span>
<span class="sd">    &gt;&gt;&gt; layout.sever_connexion(conn, time = datetime(2014, 10, 11, 23, 15), notes = &quot;Severing multiple connexions at once.&quot;)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    comp : list of :obj:`connexion` objects</span>
<span class="sd">        The connexions to sever.</span>
<span class="sd">    time : datetime.datetime</span>
<span class="sd">        The time at which to end availability.</span>
<span class="sd">    notes : string</span>
<span class="sd">        Any notes for the timestamp.</span>
<span class="sd">    force : bool</span>
<span class="sd">        If :obj:`True`, then sever any connexions that can be severed, while doing</span>
<span class="sd">        nothing (except making note of such in the logger) for connexions whose</span>
<span class="sd">        severence would violate database integrity. If :obj:`False`,</span>
<span class="sd">        :exc:`DoesNotExist` is raised for any severence that violates database</span>
<span class="sd">        integrity.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_check_user</span><span class="p">(</span><span class="s2">&quot;connexion&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">connexion</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="p">[</span><span class="n">conn</span><span class="p">]</span>

    <span class="c1"># Check that the connexions actually exist.</span>
    <span class="n">fail_conn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fail_perm</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ev</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ev_conn_sn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ev</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">c</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">connexion</span><span class="p">(),</span> <span class="n">when</span><span class="o">=</span><span class="n">EVENT_AT</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">ev_conn_sn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;=&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">event</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">event_type</span><span class="o">.</span><span class="n">perm_connexion</span><span class="p">(),</span> <span class="n">when</span><span class="o">=</span><span class="n">EVENT_AT</span>
                <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">fail_perm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;=&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">pw</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="n">fail_conn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&lt;=&gt;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">comp1</span><span class="o">.</span><span class="n">sn</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">comp2</span><span class="o">.</span><span class="n">sn</span><span class="p">))</span>
    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail_conn</span><span class="p">,</span>
        <span class="n">force</span><span class="p">,</span>
        <span class="n">AlreadyExists</span><span class="p">,</span>
        <span class="s2">&quot;Cannot disconnect because &quot;</span>
        <span class="s2">&quot;the following connexion</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> not exist at that time&quot;</span>
        <span class="o">%</span> <span class="p">(</span><span class="n">_plural</span><span class="p">(</span><span class="n">fail_conn</span><span class="p">),</span> <span class="n">_does</span><span class="p">(</span><span class="n">fail_conn</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">_check_fail</span><span class="p">(</span>
        <span class="n">fail_perm</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">LayoutIntegrity</span><span class="p">,</span> <span class="s2">&quot;Cannot disconnect permanent connexions&quot;</span>
    <span class="p">)</span>

    <span class="n">t_stamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="n">notes</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ev</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">t_stamp</span>
        <span class="n">e</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Severed connexion by ending event </span><span class="si">%d</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Severed </span><span class="si">%d</span><span class="s2"> connexion</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">.&quot;</span>
            <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="n">_plural</span><span class="p">(</span><span class="n">ev</span><span class="p">),</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ev_conn_sn</span><span class="p">))</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Severed no connexion.&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2013, CHIME Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>